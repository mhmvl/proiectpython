import sqlite3
import csv
import pandas as pd
from datetime import datetime

def initializeaza_baza_date():
    conexiune = sqlite3.connect("depozit.db")
    cursor = conexiune.cursor()
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS produse (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            denumire TEXT NOT NULL,
            cantitate INTEGER NOT NULL,
            locatie TEXT
        )
    """)
    conexiune.commit()
    conexiune.close()

def adauga_produs():
    denumire = input("ğŸ“¦ Denumirea produsului: ")
    cantitate = int(input("ğŸ”¢ Cantitate: "))
    locatie = input("ğŸ“ LocaÈ›ia Ã®n depozit: ")
    with sqlite3.connect("depozit.db") as conexiune:
        conexiune.execute("INSERT INTO produse (denumire, cantitate, locatie) VALUES (?, ?, ?)",
                          (denumire, cantitate, locatie))
    log_istoric(f"A fost adÄƒugat produsul: {denumire}, Cantitate: {cantitate}, LocaÈ›ie: {locatie}")
    print("âœ… Produs adÄƒugat cu succes.")

def afiseaza_produse():
    with sqlite3.connect("depozit.db") as conexiune:
        cursor = conexiune.execute("SELECT * FROM produse")
        rezultate = cursor.fetchall()
        if rezultate:
            print("ğŸ“‹ Produse Ã®n stoc:")
            for rand in rezultate:
                print(f"ğŸ†” ID: {rand[0]} | ğŸ“¦ Denumire: {rand[1]} | ğŸ”¢ Cantitate: {rand[2]} | ğŸ“ LocaÈ›ie: {rand[3]}")
            format_export = input("ğŸ’¾ SalveazÄƒ stocul ca TXT sau Excel (txt/excel): ").strip().lower()
            if format_export == "txt":
                salveaza_txt(rezultate)
            elif format_export == "excel":
                salveaza_excel(rezultate, cursor)
            else:
                print("âš ï¸ Format invalid. Stocul nu a fost salvat.")
        else:
            print("ğŸ“­ Depozitul este gol.")

def actualizeaza_cantitate():
    id_produs = int(input("ğŸ†” ID-ul produsului: "))
    cantitate_noua = int(input("âœï¸ Noua cantitate: "))
    with sqlite3.connect("depozit.db") as conexiune:
        conexiune.execute("UPDATE produse SET cantitate = ? WHERE id = ?", (cantitate_noua, id_produs))
    log_istoric(f"Actualizat produs ID {id_produs}, Cantitate nouÄƒ: {cantitate_noua}")
    print("âœ… Cantitatea a fost actualizatÄƒ.")

def sterge_produs():
    id_produs = int(input("ğŸ—‘ï¸ ID-ul produsului de È™ters: "))
    with sqlite3.connect("depozit.db") as conexiune:
        conexiune.execute("DELETE FROM produse WHERE id = ?", (id_produs,))
    log_istoric(f"È˜ters produs ID {id_produs}")
    print("ğŸ—‘ï¸ Produs È™ters cu succes.")

def salveaza_txt(rezultate):
    nume_fisier = f"stoc_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt"
    with open(nume_fisier, mode='w', encoding='utf-8') as fisier:
        for rand in rezultate:
            fisier.write(f"ID: {rand[0]}, Denumire: {rand[1]}, Cantitate: {rand[2]}, LocaÈ›ie: {rand[3]}\n")
    print(f"ğŸ“„ Stocul a fost salvat Ã®n fiÈ™ierul {nume_fisier}")

def salveaza_excel(rezultate, cursor):
    nume_fisier = f"stoc_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx"
    df = pd.DataFrame(rezultate, columns=[desc[0] for desc in cursor.description])
    df.to_excel(nume_fisier, index=False, engine='openpyxl')
    print(f"ğŸ“Š Stocul a fost salvat Ã®n fiÈ™ierul {nume_fisier}")

def log_istoric(actiune):
    with open("istoric.txt", "a", encoding="utf-8") as fisier:
        ora = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
        fisier.write(f"{ora} - {actiune}\n")

def meniu_principal():
    initializeaza_baza_date()
    while True:
        print("\n===== ğŸ¬ Meniu Depozit =====")
        print("1ï¸âƒ£  â• AdaugÄƒ produs")
        print("2ï¸âƒ£  ğŸ“‹ AfiÈ™eazÄƒ produse È™i salveazÄƒ stoc")
        print("3ï¸âƒ£  âœï¸ ActualizeazÄƒ cantitate")
        print("4ï¸âƒ£  âŒ È˜terge produs")
        print("5ï¸âƒ£  ğŸšª IeÈ™ire")

        alegere = input("ğŸ”½ Alege opÈ›iunea doritÄƒ: ")
        if alegere == "1":
            adauga_produs()
        elif alegere == "2":
            afiseaza_produse()
        elif alegere == "3":
            actualizeaza_cantitate()
        elif alegere == "4":
            sterge_produs()
        elif alegere == "5":
            print("ğŸ‘‹ La revedere!")
            break
        else:
            print("â— OpÈ›iune invalidÄƒ!")

if __name__ == "__main__":
    meniu_principal()
